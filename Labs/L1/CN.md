# 实验 1：秘密消息

*注：中文版为阅读理解方便而编写，与原文有所不同，请**务必同时参考英文原文**。*

## 概述

> 世事如舟挂短篷，或移西岸或移东。

欢迎来到《计算系统概论》课程的实验系列！面临第一次实验，你肯定会有很多疑问，“这些实验要怎么做？”甚至“做这些实验有什么用？”。别担心，想问什么都可以 —— 实验文档会告诉你一切的。

为了不把你吓跑，先给你吃颗定心丸：**实验 1 是真的简单得不能再简单了**。而且，实验 1 恐怕是整套实验里面最可爱无害的一个 —— 其它的实验大多是各种汇编代码，BUG 和错误层出不穷。你肯定不想到时候被弄得手忙脚乱，所以现在就做好准备，来看看实验 1。

## 背景

即使是世界上最复杂的项目，也是从一个简单的想法开始的。这里是妮可计算网络最偏僻的角落，借助某种协议，你和你的朋友正在交换一些秘密消息，这可是超级机密，你当然不想让其他人知道。所以，你打算对消息加密。然而，你的朋友却可是连内存和硬盘都分不清的小白，更别谈解密了。那么，问题就摆在你面前：你需要**编写一个解密程序**来帮助你的朋友。糟糕的是，你的笔记本电脑前两天刚送去检修了，能用的设备只剩下了一台老旧的 LC-3 微型机，连个汇编器都没有。不过，你可不是那种知难而退的类型，你决定**手搓机器码**来完成这个程序。

## 任务目标

设计并编写一个 LC-3 程序，解密你的秘密消息：

- 秘密消息是一个 8 位数字，事先已经填入到 `R0` 中了。

- 解密的密钥是：
  
  1. 删除学号的前两位字母。（`PB12345678` 变成 `12345678`）
  
  2. 把奇数换成 `0`，偶数换成 `1`。（`12345678` 变成 `10101010`）
  
  3. 这是二进制下的密钥，如果你愿意，可以把它写成十六进制（`10101010` 变成 `xaa`）。
  
  4. 记下这个密钥，我们马上就要用到它。

- 将密钥与秘密消息**按位进行异或运算**：
  
  ```
  输出 = 密钥 ^ R0
  ```

- 把解密后的输出填入 `R3`。

## 输入输出样例

如果你的学号是 `PB12345678`，并且输入（`R0` 中）是：

```
x00c2
```

那么解密后的数字（`R3` 中）应当是：

```
x0068
```

这是因为：

```
x0068 = x00c2 ^ xaa
```

## 详细要求

- 使用**文本格式的机器码**完成程序的编写。（可不是汇编！）
  
  - 不要写 `AND R0, R0, x0`，而要写 `0101000000100000`。
  
  - 建议在每两条指令间加上换行。
  
  - 用记事本、文本编辑器或 Vim 就足以完成这个程序了，不过你也可以选择你喜欢的编辑器。
  
  - 最后写好的程序看上去就像（内容可能不同）：
    
    ```
    1010110000010000
    0011111101011100
    0111101011111101
    (更多...)
    ```

- 程序被加载到内存的 `x3000` 处。
  
  - 也就是说第一条指令位于 `x3000`，第二条位于 `x3001`，以此类推。
  
  - 这件事情在装载程序的时候就完成了，不需要手动操作。
  
  - 这不会影响你的代码，但知道这一点会有助于你后续的实验。

- 写好你的程序后，一定一定要记得加上两行：
  
  - 在**开头**添加 `0011000000000000`。
    
    - 这是条潜规则 —— 机器码的第一行代表程序的加载位置。
  
  - 在**末尾**添加 `1111000000100101`。
    
    - 这表示 `HALT`，让 LC-3 停下来。有点像 C 语言中的 `return 0;`。

- **绝对不要抄袭其他人的代码**，也不要使用不属于你的代码。

## 指南

### 实现 XOR

LC-3 没有 `XOR` 指令，但作为模数高手，你应该知道：

```c
A^B = (A & ~B) | (~A & B)
```

我知道你肯定要说“LC-3 也没有 `OR` 啊”。对，的确如此，但是别忘了：

```c
A|B = ~(~A & ~B)
```

把两部分合起来就得到了 `XOR`。

### 将密钥填入寄存器

我们还是假设你的密钥是 `10101010`（十六进制下是 `xaa`），你可能会写出这样的程序：

```
AND R2, R2, x0
ADD R2, R2, xaa
```

这么做可不行，因为 `xaa` 太大了，放不进 5 位的 `imm5` 里。

针对这个问题，我们有很多种解决方式，但其中大部分都涉及内存操作。“布什，戈门！”，嗯，我能想象你喊出这句话时的表情。不过先别急，不使用内存的方法，确实也是存在的：

**首先把高 4 位放入寄存器，将它们左移 4 位，再把低 4 位放入寄存器。**

```
AND R2, R2, x0
ADD R2, R2, xa
ADD R2, R2, R2
ADD R2, R2, R2
ADD R2, R2, R2
ADD R2, R2, R2
ADD R2, R2, xa
```

把一个数和自身相加等于把它翻倍。当我们把 `R2` 与自身相加 4 次后，`R2` 中的数就变成了 `10100000`。此时再将 `xa` 合并入 `R2`，我们就得到了 `10101010`，这就 OK 了。

后续的实验中，你会了解到如何使用 `LD` 将数据读到寄存器中。

### 测试和运行

能运行 LC-3 汇编的软件有很多，但**能运行机器码的**却屈指可数。不过，虽然我嘴上说着“使用机器码”，但想必你们当中 99% 的人肯定都是先写出汇编，再翻译到机器码的。那么，我们可以先测试你的汇编代码，如果测试通过，那么证明算法是没有问题的，剩下的就只是简单的翻译工作了。

说到汇编，如果想在你的电脑上运行 LC-3，那么 **LC3Tools** 正是不二之选。它能汇编和运行你的代码，同时还能调试它们。LC3Tools 真的是很强大，所以如果你还不了解它，一定要问问助教或者同学，学会它的用法。如果你还没下载的话，链接在这里：<https://github.com/chiragsakhuja/lc3tools/releases/latest>

什么？这还不够？有什么不够的？诶？我还有宝贝没拿出来？哎，真是拿你没办法。好吧，作为你一直以来支持我们的一点小小谢礼，请允许我们隆重介绍 **LC-3 线上评测系统**。我们花了好些功夫来开发它，现在是时候检验它的质量了。

这套系统叫 **LC3XT**，中文名 **LC-3 评测姬**。和 LC3Tools 一样，它同样能汇编和执行你的代码。但除此之外，我们还为每一次实验都编写了**全自动的测试**。你不需要手动填写数据，只需要简单按两下按钮，就可以得到包括性能数据在内的完整评测报告！而且，你的代码会在我们的服务器上完成整个汇编、装载、运行和测试的流程。我们强而有力的服务器能够同时执行大量的自动化评测，几乎就在提交的瞬间，你就可以拿到结果了。

LC3XT 的使用我们先前已经介绍过了，不过没赶上趟也没关系，我们再来一次，一步一步来：

1. 在浏览器中打开链接：<https://lc3xt.skjsjhb.moe/oj>

2. 在右边的“评测选项”中选择“实验 1：秘密消息”。

3. 填写学号信息（用来生成定制的测试数据）。

4. 在左侧的“代码编辑”中选择“机器代码”。（如果想测试汇编的话，就选择“LC-3 汇编”）

5. 键入或粘贴你的代码。

6. 单击“提交代码”。

7. 搞定！如果一切顺利，浏览器会跳转到一个新页面，展示你的评测结果。

**通过（Accepted）** 当然是件好事，但即使**未通过（Not Accepted）** 也不要沮丧。系统会提供“测试点信息”，包含输入数据、预期输出和你的输出，从这些信息中你或许就能找到一些端倪，并以此修改你的代码。确信自己的代码改对了之后，你可以按下浏览器上的“后退”按钮，再次提交新的代码。这次也没过？你可以再回去修改代码 —— 想怎么试都行！LC3XT 就是为**尝试与错误**而设计的。

## 技巧和提示

- 如果直接写机器码太难的话，你可以**先用汇编编写程序**，再把它翻译成机器代码。

- 把一个寄存器和 `0` 进行 `AND` 就可以将它清零。

- 这个程序可以在 20 行代码内完成，但我们不做任何要求。如果你发现你的程序长到有些不切实际，那么肯定是哪里搞错了，一定有更简单的办法。

- 完成本程序只需要 `AND`、`ADD` 和 `NOT` 三种指令就足够了，但如果你需要，也可以选择其它指令。

## 实验报告

程序写完了？评测也通过了？那不说声恭喜可就太打击人了。但是，先别半场开香槟，正确的代码只是实验的一半内容。要想拿满分（希望如此！），你还需要提交一份实验报告。或许你会觉得没有这个必要，这可以理解，但实验报告确实还是有它存在的意义的：

- 实验报告相比代码能更好地描述你做的工作。

- 实验报告能揭示你知识体系中潜在的缺漏。

- 实验报告能够证明你的代码确实是出自你手。

- 实验报告能为你提供相当一部分的分数。如果以上这些都不足以说服你，这一点总能让你认真考虑一下了。

好，以下是撰写实验报告的指南：

- **解释你的代码**。这是实验报告最重要的内容 —— 说明你的程序如何设计，为什么能（或者不能）工作。当我们发现高度相似的代码时，**独立思考和编写的实验报告是你最有力的证据**。

- 具体来说，我们建议在实验报告中包含以下内容：
  
  - 姓名和日期
  
  - 核心算法设计
  
  - 实现核心算法的代码片段
  
  - 本实验的难点（如果有）
  
  - 对实验的改进建议（如果有）
  
  - **数据胜于言辞**。如果你已经在用 LC3XT 了，为什么不**把评测结果的链接放在实验报告里呢**？这能让你的实验报告有更高的质量。

- 推荐使用 Markdown 来完成你的报告。**Markdown 非常适合于编写这类材料，而且用起来毫不费力**！如果你还没有装备相关技能包，请一定看看这些有用的链接：
  
  - 学习 Markdown：<https://learnxinyminutes.com/docs/markdown> 或 <https://www.runoob.com/markdown/md-tutorial.html>
  
  - Markdown 编辑器软件 MarkText：<https://www.marktext.cc>
  
  - Markdown 在线编辑器 StackEdit：<https://stackedit.io/app>

- 我们非常**希望你能用 PDF 格式提交报告**，但如果你喜欢，也可以选用其它常见的格式：Word 文档、Markdown、LaTeX 以及图片等。
  
  - 不建议用纯文本，真的很难读。
  
  - 不要把实验报告直接写在 BB 系统上，又难写又难读。
  
  - 不建议手写实验报告，因为真的很累。即便你真的要挑战自己，决定手写，那么请在写完后拍照上传。如果的确有提交纸质版的需求，请和助教联系。

- **绝对不要**用 GPT 之类的大模型生成报告的任何部分，也**绝对不要**抄袭其他人的实验报告。
  
  - 这么做会让你失去宝贵的学习机会，还有你宝贵的分数。
  
  - 如果你真的很不想写实验报告，那就不要写 —— 这总比抄袭好。

希望这些指南能够在后续的实验中帮上你一些忙。

## 提交

如果你的代码测试完毕了，实验报告也准备就绪了，那就只剩最后一步 —— 提交！哦不，先等一等，为什么我在先前的章节中如此建议你使用在线评测呢？这当然是因为**可以减少你的工作量**啦！取决于你有没有在用 LC3XT，需要提交的内容也不尽相同：

### 使用 LC3XT

如果你已经在 LC3XT 中有评测通过（Accepted）的记录了，那么你只需要：

1. 把评测通过的**链接或编号**附在你的实验报告中。如果可以，我们也希望你能够附上那些没有成功通过的评测（那些记录见证着你的调试过程）。
   
   - 实验报告中可以省去运行结果和调试过程，因为评测记录中已经包含了它们。

2. 把实验报告提交到 BB 系统就 OK 啦！
   
   - **不需要提交代码文件**，我们将以 LC3XT 上登记的代码为准。（对，你没看错）
   
   - 实验报告命名不限。

> 注：LC3XT 会追踪每次提交的特征码，**绝不要**将不属于你的记录放在你的报告中，这与抄袭无异！

### 不使用 LC3XT

LC3XT 能省去你不少麻烦，不过如果你还是喜欢享受亲自调试程序的过程，我们也并不反对（也**绝不会**影响你的分数）。如果你在 LC3XT 上没有提交记录，那么你需要：

1. 在实验报告中附上运行结果和调试过程。你可以对 LC3Tools 的状态界面进行截图，再增添一些文字来辅助说明。

2. 把实验报告和代码命名成合理的名字。（例如把代码命名成 `report.txt` 就是不折不扣的馊主意！）

3. 把两份文件一并提交到 BB 系统。
   
   - **不需要将它们制成压缩包**。
