# ICS-3 数字风暴

> 十则围之，五则攻之，倍则分之。

你也许已经知道，对大多数 ISA 来说，除法和模数都是一项很慢的工作：

```c
int r = a % (1e9 + 7);
```

—— 这样看似轻松的代码，运行起来却需要昂贵的代价。虽然在 x86 中它仍能以单一 `IDIV` 指令来实现，但其背后则是一段复杂的微码程序，用以实现不那么简单的除法操作。

:::tip 术语库

在 CISC 指令集中，**微码（Microcode）** 就是“汇编的汇编，指令的指令”，它允许编译器使用一条指令完成复杂的功能，但这些指令在电路上并非于一个指令周期完成，而是又分为许多条更小的“指令”，就像原子核和核子的关系一样。

:::

这样的操作到底有多困难？也许今天的实验能帮你找到一些答案。

## 目标

给定不超过 $ 2^{32} $ 的正数 `x`，计算 `x % 7` 的结果。

- 输入以二进制补码（由于数据为正数，也就是原码）形式从键盘读入，且在最后有字符 `y` 标识结束。
- 输出以十进制（当然，可以是任何高于七进制的进制……）形式，以字符串输出到控制台。
- 程序至多只能执行 10000 条指令。
- 在输入和输出的末尾都没有换行符。
- 输入没有前导 0。

## 输入输出样例

输入（键盘）：

```
100110000100110100011101y
```

输出（控制台）：

```
4
```

这是因为 `9981213 % 7 = 4`。

## 指南

### 记忆碎片

最大值 $ 2^{32} $ 是一个很大的数，它不能放在一个通用寄存器中。当然，你可以把几个寄存器拼起来，或者借助内存来存储这些信息。可你知道吗？即使程序只能使用固定数目的存储器，要计算这个模数也是可以办到的，并且这要比一次读取所有输入简单得多。

这个问题的解决思路在于不要想着“一下把整个数读取进来”，而是根据输入逐步去计算模数。这个过程有点像是数学归纳法，由于输入是从左到右一位一位输入的，所以我们只需要明确以下三个要点：

1. 计算出第一个数位（即最高位）模 7 的结果。由于没有前导 0，最高位只能是 `1`。
2. 假设我们已经计算出前 `k` 位模 7 的结果，模数为 `x`。
3. 现在在最后增加一位，总位数变成 `k + 1` 位，设新添加的位是 `b`，利用 `x` 和 `b` 计算新的模数。

1 和 2 都很简单，而 3 只需要一点额外的数学知识：

- 如果前 $ k $ 位表示数 $ m $，那么在其后添上一位 $ b $ 后，表示的数就是 $ 2m + b $。
- 如果 $ m \equiv x\ (mod \ 7) $，那么 $ 2m + b \equiv 2x + b\ (mod\ 7) $。
- 由于模数不能大于 7，因此从 $ 2x + b $ 中不断减去 7，直到它小于 7。

使用这个算法，每次读入输入的一位后，我们就更新当前已经算出的模数。当看到 `y` 后，再将结果输出即可。

### 语文与数学

从键盘输入（以及要输出到控制台）的内容都是 ASCII 字符，而不是数字本身。在学习 C 语言时，你应该已经知道：

```c
'1' == 1;   // false
```

字符 `'1'` 的 ASCII 编码是 `49`，也就是说，如果你把它放在一个寄存器里，它的二进制表示就是 `0...0110001`，这和数字 `1` 的表示 `0...01` 是不同的。要把字符转换为数字（或者反过来），我们就需要一些运算。

幸运的是，设计 ASCII 编码的人非常自然地给数字 `0` 到 `9` 指派了连续的编码，即 `48` 到 `57`，也就是说，十进制中的单个数位 `i` 与它对应的字符 `c` 之间有固定差值 `48`，只要加上或减去这个数，就可以在数字和字符间转换。

### 系统中断

从键盘读入一个字符的最简单方式是使用系统调用（中断，或者按 TRAP 一词译作“陷阱”） `GETC`，它从键盘上读入一个字符，并将其存入 `R0`。如果当前的输入缓冲区为空，那么它会等待下一个字符，就像 C 语言中的 `getc` 函数那样。

类似地，要将一个字符输出到控制台，只需要使用对应的 `OUT` 调用：先将要输出的字符编码存入 `R0`，再调用 `OUT`，它就会帮我们完成一系列相关的控制操作，最终将字符显示在控制台上。

:::info 模拟信号

由于系统上没有真正的键盘，LC-3 评测姬对该实验采用缓冲输入的方式，也就是说，输入只能使用 `GETC` 或 `IN` 读取，硬件寄存器 `KBSR` 或 `KBDR` 不会反映这些输入，即使手动开放中断也是如此。类似地，输出必须使用 `OUT` 或 `PUTS`，直接写入 `DSR` 或 `DDR` 的内容也不会被系统检测。LC3Tools 没有这样的限制，因为它将你的键盘与硬件寄存器直接相连。

:::
