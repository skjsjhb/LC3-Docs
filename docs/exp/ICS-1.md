# ICS-1 或许有时

> 几回缺月还圆月，数阵南风又北风。

请看以下的 C 语句：
  
```c
int a = cond ? val1 : val2;
```

这是一个非常简单的条件赋值语句，当 `cond` 为 `0` 时，`a` 被赋值为 `val2`，否则被赋值为 `val1`。像这样的结构在大型程序中比比皆是，生成和优化它们也是编译器的工作之一。作为系列实验的第一项，让我们来了解这样的语句是如何在 CPU 上以机器码形式执行的。值得一提的是，虽然我们使用的是 LC-3 指令集，但即使是现代的指令集（如 RISC-V），工作原理也非常类似。

## 目标

使用**机器代码（二进制码）**，编写一个 LC-3 程序，完成三目运算符的功能。

- `cond` 存放在 `R0` 中，取值为 `0` 或 `1`。
- `val1` 存放在 `R1` 中，值任意。
- `val2` 存放在 `R2` 中，值任意。
- 输出存放在 `R0` 中。
- 至多只允许执行 100 条指令（这已经很多了！）。

## 输入输出样例

输入：

```
R0 = 0
R1 = x1145
R2 = x1919
```

输出：

```
x1919
```

## 注意事项

- **这个程序必须使用机器代码完成。** 这也是唯一一个需要机器语言完成的实验。

  - 机器代码使用文本输入，一行一条指令，例如：

    ```
    0000111100001111
    1111000011110000
    ```

    :::info 演习模式

    与真正的二进制程序不同，此处的 `0` 和 `1` 是**字符**，而不是二进制数值，也就是说，要使用记事本或 Vim 的文本模式，通过数字小键盘或者主键盘按钮直接键入，而不要使用二进制编辑模式。尽管这会让文件的长度增长到 8 倍，但作为课程实验来说，这样编写起来更容易。

    :::

  - 在 LC-3 评测姬中评测时，请在“语言”下拉框中选择“机器代码”，再键入程序。

  - 在 LC3Tools 中调试时，可以在运行页面手动编辑内存，并以十六进制键入程序。

- 系统从 `x3000` 开始运行程序。

- 机器代码的第一行代表**程序装载位置**，以二进制表示。也就是说，如果装载位置是 `0000000000000000`（`x0000`），那么第二行（即第一条指令）会被填在内存 `x0000` 的位置，第三行填在 `x0001`，以此类推。

    :::tip 调谐频率

    LC-3 要求程序必须决定自己的**装载位置**，也就是机器代码将被放在内存的哪个位置。注意，程序的装载位置**不一定是它开始执行的位置**，在 LC-3 上，用户程序从 `x3000` 开始执行，这是无法改变的 —— 如果你把程序放在 `x4000`，而 `x3000` 那里恰好有个死循环，那么你的程序就永远不会被执行。

    因此，程序需要装入 `x3000`，也就是把你想要执行的第一条指令放在 `x3000`。当然，你可以选择把程序装入 `x2f00`，再填上 256 条没什么用的指令，但通常来说，我们会将程序的装载点与起始地址对齐。因此，你应该将 `0011000000000000`（`x3000` 的二进制值）放在机器代码的第一行：

    ```
    0011000000000000    ; 表示第一条指令应装入 x3000
    1111000011110000    ; 第一条要执行的指令，将被填入 x3000
    ; 程序的剩余部分
    ```

    （当然，LC-3 评测姬不支持机器代码注释，上述的注释只是为了方便说明。）

    这样第二行的内容就是第一条要执行的指令。

    在 LC-3 中，程序可以像这样自行决定装载地址，这是因为我们只有一个程序。如果系统上同时要运行很多程序，而它们决定装载在相同的位置呢？那就麻烦了！系统必须决定装载一个程序，而拒绝运行另一个，仅仅是因为内存空间冲突。幸运的是，这样荒唐的事情不会在现代操作系统上发生，因为编写操作系统的人已经考虑到了这种问题，并设计了一系列解决方法。
    :::

- 所有操作都应当在寄存器中完成，而不访问内存（取指除外）。

- 程序的最后必须有一条 `HALT` 指令，即 `1111000000100101`，这让 LC-3 停下来，不再去执行之后的指令，就像大多数 C 程序在最后都需要一条 `return 0;` 一样。

## 指南

### 从这里，到那里

三目运算符的本质就是：

- 检查 `cond` 是否为 `0`。
- 如果是 `0`，就把 `R2` 写入 `R0`。
- 否则，把 `R1` 写入 `R0`。

我们可以使用 `BR` 及其变种来完成“检测和跳转”功能，例如，`BRp` 在条件码 P 置位时，就跳转到你指定的位置，否则，它继续向下执行。下面的伪代码可以更好地解释这一点：

```
设置条件码
BRp 目标位置

P 不置位时，要做的事（片段 A）

目标位置

P 置位时，要做的事（片段 B）
```

:::info 然后呢？

与 C 中的 `if` 不同，片段 A 执行完成后，会继续向下执行片段 B。如果不想让这种事情发生，需要在片段 A 的末尾添加一条 `BR` 指令，跳过整个片段 B。

:::

### 我与我之外

要怎么给条件码置位呢？或者说，在本例里，如何根据 `R0` 的值，给条件码置位呢？能设置条件码的指令就那么几条，由于不访问内存，那肯定不是 `LD`、`LDI`、`LDR`，因此，剩下的只有 `ADD`、`AND` 和 `NOT` 了，它们都会根据结果的正负性，相应设置条件码为 N、Z 或 P。

不过，我们想要判断的值在 `R0` 中，并不是某个运算的结果，这该怎么办？其实很简单，我们只需要让 `R0` 的值**成为这些指令的结果**就好了。`ADD` 可以和 `x0` 相加，而 `AND` 则可以与自身进行与运算，这都会把 `R0` 的值原封不动地作为这些指令的结果输出，同时还会设置条件码。

:::tip 买椟还珠

在汇编编程中，像这样为了某条指令的副作用而进行额外的计算，其实是时有发生的事情。在编译高级语言时，哪怕是使用一些现代的指令集，生成的二进制程序中也可能包含这样的指令，因为有时候编译器别无选择。

:::

对于 `NOT` 而言，通过连续使用两次 `NOT R0, R0`，也可以将 `R0` 初始的值作为运算结果输出。不过，其实仅使用一次 `NOT`，也可以判定 `R0` 的正负性，只需要对程序结构做一些小小的修改。你知道该怎么做吗？

与设置条件码类似，要把一个寄存器的值复制到另一个寄存器，也可以使用指令的副作用来完成，例如，要把 `R1` 的内容存入 `R0`，则只需要一条 `ADD R0, R1, x0`。

### 到此为止

在程序的最后（或者每个你希望程序停止的位置）需要使用 `HALT` 来停止程序。在编写 C 程序的时候，一个函数到达其末尾就算结束了（不论那里是否有 `return`），程序会回到调用函数中。然而，CPU 在执行指令时却没有这样的概念，一个机器代码程序看上去好像是到了“终点”，可 CPU 是不会主动停下的，它会继续执行下一条指令。要告诉 LC-3 “程序到此为止了”，就需要填入一条 `HALT`。

正确地停止程序非常重要，原因有两个：

- 在最后一条指令之后的内存**未初始化**，里面的东西是乱七八糟的，无法预测 CPU 接下来会做什么 —— 例如，如果碰巧有一条指令是 `AND R0, R0, x0`，那么我们宝贵的计算结果就会被覆盖掉，没有理由认为这不会发生。
- 如果不停止程序，无论是 LC-3 评测姬还是 LC3Tools 都无法读取输出的值。

在高级语言中，编译器或运行环境会自动加上跳转和终止指令，但读者应当明白，这是编写编译器或运行环境的人为我们考虑到的，并不是 CPU 生来就有的性质，而现在轮到我们做这项工作了。

## 测评与提交

你可以在 LC-3 评测姬上完成整个实验。不过，如果你想要使用一些其它的工具，那么也可以使用记事本、Vim 或者其它代码编辑器来编写机器代码 —— 毕竟只是些 0 和 1 罢了。

在完成实验后，请编写一份实验报告或实验简评，应包含以下内容：

- 姓名和学号（当然，其实这不是 100% 必要的……）
- 代码的设计思路
- 实验收获（若有）
- 调试过程所遇问题（若有）
- 感想或改进意见（可选）

如果不使用 LC-3 评测姬，请再加上以下内容：

- 完整的代码（可嵌入在文档中）
- 成功运行的截图

实验报告以自我总结和举一反三为要，不以篇幅或排版论英雄。

:::danger 这不属于你

尽管我们希望永远用不上，但我们不得不在此特别强调实验的纪律问题，并郑重向读者提出如下要求：

- 绝不要复制粘贴他人的代码或其它材料，无论是全部还是部分。

  诚然，把别人的东西拿来用，要比自己去思考容易得多。然而，靠复制粘贴应付作业和考试，并不能让你掌握到真正的知识 —— 那些现在看来可能不值一提，但也许会在未来的课程、你的毕业设计甚至研究生生涯中要用到的基础知识。这并不是“LC-3 有 15 种指令”这样的鸡毛蒜皮，而是当你看到两级分支预测器这种“不靠谱”的东西时，你能回想起分支指令（在 LC-3 中是 `BR`）的结构是如此相似，然后就能理解为什么这种方法看上去投机取巧，但实际效果居然还不错。

  如果你认为本课程的内容过于简单，实验没有完成的价值，或者只是极度厌恶实验报告 —— 那就不要写，这总比抄袭要好。

- 绝不要用 AI 工具生成代码或文档。

  理由和上一点差不多，AI 可以帮助你，但不能替代你 —— 至少它不能代你参加课程的期末考试。
:::

在完成实验报告或实验简述后，请将其**上传至 BB 系统**中的相应部分。若在 LC-3 评测姬中提交了代码，则系统会自动登记，不再需要手动上传代码；若使用 LC3Tools 或其它工具运行，则需要提交代码，代码可嵌入文档或作为单独文件提交。

上传文件时，请选择常见的文档格式（PDF、Word、OpenDocument 或 Markdown 等都可以），但请注意：

- 不建议使用 LaTeX、图片或手写，如果你坚持，请将它们渲染或转换为 PDF。
- 若要上传多个文件，请**不要**将文件放置在压缩包中。

在打开 Word 或者 TeXworks 之前，为什么不试试 Markdown 呢？世界上绝大多数计算机软件项目都使用 Markdown 作为文档格式，因为它编写方便，无需渲染也能阅读，而且掌握起来非常容易。如果你还没有学习过它，可以参考 [Y 分钟速成 Markdown](https://learnxinyminutes.com/zh-cn/markdown/)。如果需要一个编辑器，那么可以试试 [StackEdit](https://stackedit.io/app)，它支持在浏览器中直接编辑。